name: Copilot PR Autofix

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name (used to locate PR if pr_number not provided)'
        required: false
      pr_number:
        description: 'Pull Request number to comment on'
        required: false
      head_sha:
        description: 'Commit SHA for idempotency marker'
        required: false
      run_url:
        description: 'Optional URL to the failing CI run'
        required: false
      run_id:
        description: 'Optional workflow run id to derive run url, head sha, branch and PR'
        required: false
  workflow_run:
    workflows:
      - "CI and Deploy"
      - "Pre-flight Checks"
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  ping-copilot-dispatch:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Post PR comment via dispatch to trigger Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = context.payload.inputs || {};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // If run_id is provided, enrich context from the run
            let runUrl = inputs.run_url || '';
            let headShaFromRun = undefined;
            let branchFromRun = undefined;
            let prNumber = inputs.pr_number ? Number(inputs.pr_number) : undefined;
            if (inputs.run_id) {
              const runIdNum = Number(inputs.run_id);
              try {
                const { data: run } = await github.rest.actions.getWorkflowRun({ owner, repo, run_id: runIdNum });
                runUrl = runUrl || run.html_url || '';
                headShaFromRun = run.head_sha;
                branchFromRun = run.head_branch;
                if (!prNumber) {
                  try {
                    const prsForRun = await github.rest.actions.listWorkflowRunPullRequests({ owner, repo, run_id: runIdNum, per_page: 10 });
                    const prItem = prsForRun.data.pull_requests && prsForRun.data.pull_requests[0];
                    if (prItem && prItem.number) {
                      prNumber = prItem.number;
                    }
                  } catch (e) {
                    core.info('Could not list PRs for run; will fall back to branch matching if needed.');
                  }
                }
              } catch (e) {
                core.info('Could not fetch workflow run by run_id; proceeding without it.');
              }
            }

            if (!prNumber) {
              const branch = inputs.branch || branchFromRun;
              if (!branch) {
                core.setFailed('Provide at least one of: pr_number, branch, or run_id that is associated with a PR.');
                return;
              }
              const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', per_page: 100 });
              const match = prs.find(p => p.head && p.head.ref === branch);
              if (!match) {
                core.setFailed(`No open PR found for branch '${branch}'.`);
                return;
              }
              prNumber = match.number;
            }

            // Determine head SHA for idempotency
            let headSha = inputs.head_sha || headShaFromRun;
            if (!headSha) {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              headSha = pr.head && pr.head.sha ? pr.head.sha : undefined;
            }
            const marker = headSha ? `<!-- copilot-autofix:${headSha} -->` : `<!-- copilot-autofix:manual -->`;

            // Avoid duplicate comments for the same commit
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });
            if (headSha && comments.some(c => (c.body || '').includes(marker))) {
              core.info('Copilot autofix comment already exists for this commit. Skipping.');
              return;
            }

            const finalRunUrl = runUrl || '';
            const bodyLines = [
              marker,
              '**Build failed. @copilot please fix.**',
              '',
              finalRunUrl ? `Run: ${finalRunUrl}` : '',
              headSha ? `Commit: ${headSha}` : '',
              '',
              'Guidance:',
              '- Use `.github/workflows/copilot-instructions.md`.',
              '- Keep the change minimal and get CI green.',
              '- Push commits to this branch.'
            ].filter(Boolean);

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: bodyLines.join('\n'),
            });

            // Optionally label the PR for tracking
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['autofix', 'copilot']
              });
            } catch (e) {
              core.info('Could not add labels (may not exist or insufficient permissions).');
            }

  ping-copilot-on-pr:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'failure' &&
        github.event.workflow_run.event == 'pull_request'
      }}
    runs-on: ubuntu-latest
    steps:
      - name: Post PR comment to trigger Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const pr = run.pull_requests && run.pull_requests[0];
            if (!pr) {
              core.info('No PR associated with this run. Skipping.');
              return;
            }
            const prNumber = pr.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = `<!-- copilot-autofix:${run.head_sha} -->`;

            // Avoid duplicate comments for the same commit
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });
            if (comments.some(c => (c.body || '').includes(marker))) {
              core.info('Copilot autofix comment already exists for this commit. Skipping.');
              return;
            }

            const bodyLines = [
              marker,
              '**Build failed. @copilot please fix.**',
              '',
              `Run: ${run.html_url}`,
              `Branch: ${run.head_branch}`,
              `Commit: ${run.head_sha}`,
              '',
              'Guidance:',
              '- Use `.github/workflows/copilot-instructions.md`.',
              '- Keep the change minimal and get CI green.',
              '- Push commits to this branch.'
            ];

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: bodyLines.join('\n'),
            });

            // Optionally label the PR for tracking
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: ['autofix', 'copilot']
              });
            } catch (e) {
              core.info('Could not add labels (may not exist or insufficient permissions).');
            }